{% extends "base.html" %}

{% block title %}æ·»åŠ æœˆåº¦ç›®æ ‡ - æµæ°´ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>ğŸ¯ æ‰‹åŠ¨æ·»åŠ æœˆåº¦ç›®æ ‡</h2>
    </div>
    <div class="card-body">
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        
        <form method="POST">
            <div class="form-group mb-3">
                <label for="customer_name" class="form-label">é€‰æ‹©å®¢æˆ·</label>
                <div class="input-group">
                    <input type="text" 
                           id="customer_name" 
                           name="customer_name" 
                           class="form-control" 
                           list="customerList"
                           placeholder="è¾“å…¥å®¢æˆ·åæœç´¢æˆ–ç‚¹å‡»æ·»åŠ æ–°ç”¨æˆ·"
                           required>
                    <button class="btn btn-outline-primary" type="button" id="addNewCustomerBtn">â• æ–°å»º</button>
                </div>
                <datalist id="customerList">
                    {% for customer in customers %}
                    <option value="{{ customer.username }}" data-id="{{ customer.id }}"></option>
                    {% endfor %}
                </datalist>
                <input type="hidden" id="customer_id" name="customer_id" required>
            </div>
            
            <div class="mb-3">
                <label for="period_number" class="form-label">æµæ°´æœŸæ•°</label>
                <select class="form-select" id="period_number" name="period_number" required>
                    {% for i in range(1, 13) %}
                    <option value="{{ i }}">ç¬¬ {{ i }} æœŸ</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">æ—¶é—´èŒƒå›´</label>
                <div class="input-group mb-2">
                    <span class="input-group-text">å¼€å§‹</span>
                    <input type="date" class="form-control" name="start_date" required>
                </div>
                <div class="input-group">
                    <span class="input-group-text">ç»“æŸ</span>
                    <input type="date" class="form-control" name="end_date" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="target_amount" class="form-label">ç›®æ ‡é‡‘é¢ (å…ƒ)</label>
                <input type="number" step="0.01" class="form-control" id="target_amount" name="target_amount" required>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block-mobile">
                ğŸ’¾ ä¿å­˜ç›®æ ‡
            </button>
            
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary btn-block-mobile">
                è¿”å›
            </a>
        </form>
        
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <p style="margin-bottom: 10px; font-weight: bold;">ğŸ’¡ æç¤ºï¼š</p>
            <p style="line-height: 1.6;">å¦‚æœæ²¡æœ‰Excelæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½æ‰‹åŠ¨ä¸ºå®¢æˆ·è®¾ç½®æœˆåº¦æµæ°´ç›®æ ‡ã€‚è®¾ç½®åï¼Œå¯ä»¥ä½¿ç”¨"å½•å…¥æµæ°´"åŠŸèƒ½æ·»åŠ æ¯æ—¥æµæ°´è®°å½•ã€‚</p>
        </div>
        
        <!-- æ·»åŠ ç”¨æˆ· Modal -->
        <div id="addCustomerModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
            <div class="modal-content" style="background-color: #fff; padding: 20px; border-radius: 5px; width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative;">
                <h3 style="margin-top: 0;">æ·»åŠ æ–°ç”¨æˆ·</h3>
                <form id="addCustomerForm">
                    <div class="form-group mb-3">
                        <label for="new_customer_name" class="form-label">ç”¨æˆ·å</label>
                        <input type="text" id="new_customer_name" class="form-control" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                        <small class="text-muted">é»˜è®¤å¯†ç : 123456</small>
                    </div>
                    <div style="text-align: right;">
                        <button type="button" class="btn btn-secondary btn-sm" id="cancelAddCustomer">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary btn-sm">ç¡®å®š</button>
                    </div>
                </form>
                <button id="closeCustomerModal" style="position: absolute; top: 10px; right: 10px; border: none; background: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
        </div>

        <script>
        document.addEventListener('DOMContentLoaded', function() {
            // å®¢æˆ·åç§°å˜æ›´æ—¶ï¼ŒåŒæ­¥ID
            document.getElementById('customer_name').addEventListener('change', function() {
                const datalist = document.getElementById('customerList');
                const options = datalist.querySelectorAll('option');
                
                options.forEach(option => {
                    if (option.value === this.value) {
                        document.getElementById('customer_id').value = option.dataset.id;
                    }
                });
            });
            
            // æ·»åŠ æ–°ç”¨æˆ·
            document.getElementById('addNewCustomerBtn').addEventListener('click', () => {
                document.getElementById('addCustomerModal').style.display = 'flex';
                document.getElementById('new_customer_name').focus();
            });
            
            // å…³é—­æ¨¡æ€æ¡†
            document.getElementById('closeCustomerModal').addEventListener('click', () => {
                document.getElementById('addCustomerModal').style.display = 'none';
            });
            
            document.getElementById('cancelAddCustomer').addEventListener('click', () => {
                document.getElementById('addCustomerModal').style.display = 'none';
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('addCustomerModal').addEventListener('click', (e) => {
                if (e.target.id === 'addCustomerModal') {
                    document.getElementById('addCustomerModal').style.display = 'none';
                }
            });
            
            // æäº¤æ–°ç”¨æˆ·è¡¨å•
            document.getElementById('addCustomerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const username = document.getElementById('new_customer_name').value;
                const password = '123456';  // é»˜è®¤å¯†ç 
                
                try {
                    const response = await fetch('/admin/api/add_customer', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username, password})
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // æ›´æ–°datalist
                        const datalist = document.getElementById('customerList');
                        const option = document.createElement('option');
                        option.value = result.username;
                        option.dataset.id = result.id;
                        datalist.appendChild(option);
                        
                        // è‡ªåŠ¨é€‰ä¸­æ–°ç”¨æˆ·
                        document.getElementById('customer_name').value = result.username;
                        document.getElementById('customer_id').value = result.id;
                        
                        // æ¸…ç©ºè¡¨å•
                        document.getElementById('addCustomerForm').reset();
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        document.getElementById('addCustomerModal').style.display = 'none';
                        alert('ç”¨æˆ·æ·»åŠ æˆåŠŸï¼');
                    } else {
                        alert('æ·»åŠ å¤±è´¥ï¼š' + result.error);
                    }
                } catch (error) {
                    console.error('æ·»åŠ ç”¨æˆ·é”™è¯¯:', error);
                    alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            });
        });
        </script>
    </div>
</div>
{% endblock %}
