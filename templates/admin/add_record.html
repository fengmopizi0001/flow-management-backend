{% extends "base.html" %}

{% block title %}å½•å…¥æµæ°´ - æµæ°´ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
            <div class="card-header">
        <h2>â• å½•å…¥æµæ°´è®°å½•</h2>
    </div>
    <div class="card-body">
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        
        <form method="POST">
            <div class="form-group">
                <label for="customer_id" class="form-label">é€‰æ‹©å®¢æˆ·</label>
                <select id="customer_id" name="customer_id" class="form-control form-select" required>
                    <option value="">-- è¯·é€‰æ‹©å®¢æˆ· --</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}">{{ customer.username }}</option>
                    {% endfor %}
                </select>
            
            <div class="form-group">
                <label class="form-label">æ—¥æœŸ</label>
                <div class="date-picker-container">
                    <select class="form-control year-select" id="record_year" name="record_year"></select>
                    <select class="form-control month-select" id="record_month" name="record_month"></select>
                    <select class="form-control day-select" id="record_day" name="record_day"></select>
                    <input type="hidden" id="date" name="date" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="amount" class="form-label">æµæ°´é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                <input type="number" 
                       id="amount" 
                       name="amount" 
                       class="form-control" 
                       placeholder="è¯·è¾“å…¥æµæ°´é‡‘é¢"
                       step="0.01"
                       min="0"
                       required>
            </div>
            
            <div class="form-group">
                <label for="status" class="form-label">çŠ¶æ€</label>
                <select id="status" name="status" class="form-control form-select" required>
                    <option value="done" selected>å·²åˆ·</option>
                    <option value="pending">å¾…åˆ·</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="operator_id" class="form-label">æ“ä½œäºº</label>
                <select id="operator_id" name="operator_id" class="form-control form-select">
                    <option value="">-- è¯·å…ˆé€‰æ‹©å®¢æˆ· --</option>
                </select>
                <small class="form-text text-muted">é€‰æ‹©å®¢æˆ·åè‡ªåŠ¨åŠ è½½å…³è”çš„æ“ä½œå‘˜</small>
            </div>
            
                <button type="submit" class="btn btn-primary btn-block-mobile">
                â• æ·»åŠ æµæ°´
            </button>
            
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary btn-block-mobile">
                è¿”å›
            </a>
        </form>
        
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
            <p style="margin-bottom: 10px; font-weight: bold;">ğŸ’¡ æç¤ºï¼š</p>
            <ul style="margin-left: 20px; line-height: 1.8;">
                <li>ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºå½“æ—¥æ±‡æ€»è®°å½•</li>
                <li>å¯ä»¥å¤šæ¬¡æ·»åŠ åŒä¸€æ—¥æœŸçš„æµæ°´</li>
                <li>å®¢æˆ·å¯ä»¥åœ¨æµæ°´æ˜ç»†é¡µé¢æŸ¥çœ‹å¹¶æ ‡è®°æµæ°´çŠ¶æ€</li>
            </ul>
        </div>
        
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            function loadOperators(customerId) {
                const operatorSelect = document.getElementById('operator_id');
                operatorSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
                operatorSelect.disabled = true;
                
                fetch(`/admin/operators/api/list/${customerId}`)
                    .then(response => response.json())
                    .then(data => {
                        operatorSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ“ä½œå‘˜ --</option>';
                        
                        // æ·»åŠ ç®¡ç†å‘˜é€‰é¡¹
                        const adminOption = document.createElement('option');
                        adminOption.value = '999999';
                        adminOption.textContent = 'ç®¡ç†å‘˜';
                        operatorSelect.appendChild(adminOption);
                        
                        if (data.operators && data.operators.length > 0) {
                            data.operators.forEach(op => {
                                const option = document.createElement('option');
                                option.value = op.id;
                                option.textContent = op.name;
                                operatorSelect.appendChild(option);
                            });
                        } else {
                            // å¦‚æœæ²¡æœ‰æ“ä½œå‘˜ï¼Œåªæ˜¾ç¤ºç®¡ç†å‘˜ï¼ˆä¸Šé¢å·²æ·»åŠ ï¼‰å’Œæç¤ºä¿¡æ¯
                            const option = document.createElement('option');
                            option.value = "";
                            option.textContent = "è¯¥å®¢æˆ·æš‚æ— å…¶ä»–æ“ä½œå‘˜";
                            option.disabled = true;
                            operatorSelect.appendChild(option);
                        }
                        operatorSelect.disabled = false;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        operatorSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
                        operatorSelect.disabled = false;
                    });
            }

            // å®¢æˆ·IDå˜æ›´æ—¶ï¼ŒåŠ è½½æ“ä½œå‘˜
            const customerSelect = document.getElementById('customer_id');
            if (customerSelect) {
                customerSelect.addEventListener('change', function() {
                    const customerId = this.value;
                    console.log('Customer selected:', customerId); // Debug
                    if (customerId) {
                        loadOperators(customerId);
                    } else {
                        document.getElementById('operator_id').innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©å®¢æˆ· --</option>';
                    }
                });
            }
        });
        </script>
    </div>
</div>
{% endblock %}
