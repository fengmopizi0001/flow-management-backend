{% extends "base.html" %}

{% block title %}å¯¼å…¥Excel - æµæ°´ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<style>
    /* æ‰‹æœºç«¯å¡ç‰‡å¼å¸ƒå±€ä¼˜åŒ– */
    .import-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        overflow: hidden;
    }

    .mode-switch-container {
        display: flex;
        background: #f0f2f5;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 20px;
    }

    .mode-switch-option {
        flex: 1;
        text-align: center;
        padding: 10px 0;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s ease;
        color: #64748b;
    }

    .mode-switch-option.active {
        background: #fff;
        color: var(--primary-color);
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .mode-switch-input {
        display: none;
    }

    .file-upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: 12px;
        padding: 30px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #f8fafc;
        margin-bottom: 20px;
        position: relative;
    }

    .file-upload-area:hover, .file-upload-area.drag-over {
        border-color: var(--primary-color);
        background: #eff6ff;
    }
    
    .file-upload-icon {
        font-size: 32px;
        margin-bottom: 10px;
        display: block;
    }
    
    .file-upload-text {
        font-weight: 600;
        color: #475569;
        margin-bottom: 5px;
    }
    
    .file-upload-hint {
        font-size: 12px;
        color: #94a3b8;
    }
    
    .file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        font-weight: 600;
        color: #334155;
        margin-bottom: 8px;
        display: block;
    }
    
    .period-select-wrapper {
        position: relative;
    }
    
    .period-select-wrapper::after {
        content: "â–¼";
        font-size: 12px;
        color: #64748b;
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }

    .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 16px;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-primary-custom {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 6px rgba(37, 99, 235, 0.2);
    }
    
    .btn-primary-custom:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 8px rgba(37, 99, 235, 0.3);
    }
    
    .btn-secondary-custom {
        background: #f1f5f9;
        color: #475569;
        margin-top: 10px;
    }

    /* æ–‡ä»¶åæ˜¾ç¤ºåŒºåŸŸ */
    #file-name-display {
        margin-top: 10px;
        padding: 8px 12px;
        background: #e2e8f0;
        border-radius: 6px;
        font-size: 14px;
        color: #334155;
        display: none;
        align-items: center;
    }
    
    #file-name-display i {
        margin-right: 8px;
    }
</style>

<div class="import-card">
    <div class="card-header" style="padding: 20px 20px 10px;">
        <h2 style="margin: 0; font-size: 1.25rem;">ğŸ“¥ å¯¼å…¥Excelæœˆåº¦æµæ°´è¡¨</h2>
    </div>
    <div class="card-body" style="padding: 20px;">
        {% if success %}
        <div class="alert alert-success">
            <h3>âœ… å¯¼å…¥æˆåŠŸï¼</h3>
            <ul>
                <li>å®¢æˆ·ï¼š{{ customer_name }}</li>
                <li>æœŸæ•°ï¼šç¬¬ {{ request.form.get('period_number', 1) }} æœŸ</li>
                <li>èµ·å§‹æ—¥æœŸï¼š{{ start_date }}</li>
                <li>ç»“æŸæ—¥æœŸï¼š{{ end_date }}</li>
                <li>æœˆåº¦ç›®æ ‡ï¼šÂ¥{{ "{:,.2f}".format(total_amount) }}</li>
                <li>æµæ°´è®°å½•ï¼š{{ record_count }} ç¬”</li>
            </ul>
            {% if is_new_user %}
            <p style="margin-top: 15px;">
                å®¢æˆ·è´¦æˆ·å·²åˆ›å»ºï¼Œç”¨æˆ·åï¼š<strong>{{ customer_name }}</strong>ï¼Œé»˜è®¤å¯†ç ï¼š<strong>123456</strong>
            </p>
            {% else %}
            <p style="margin-top: 15px;">
                å·²æ›´æ–°å®¢æˆ· <strong>{{ customer_name }}</strong> çš„æ•°æ®ï¼Œæ—§æ•°æ®å·²è¢«è¦†ç›–
            </p>
            {% endif %}
            <div style="margin-top: 20px;">
                <a href="{{ url_for('admin.dashboard') }}" class="btn btn-primary btn-block-mobile">è¿”å›ä»ªè¡¨ç›˜</a>
                <a href="{{ url_for('admin.import_excel') }}" class="btn btn-secondary btn-block-mobile">ç»§ç»­å¯¼å…¥</a>
            </div>
        </div>
        {% else %}
        
        {% if error %}
        <div class="alert alert-danger">{{ error }}</div>
        {% endif %}
        
        <form method="POST" enctype="multipart/form-data" id="importForm">
            <!-- æ¨¡å¼åˆ‡æ¢ -->
            <div class="mode-switch-container">
                <label class="mode-switch-option active" id="option-new">
                    <input type="radio" name="user_mode" value="new" class="mode-switch-input" checked onchange="toggleCustomerSelect(this)">
                    ğŸ†• æ–°ç”¨æˆ·
                </label>
                <label class="mode-switch-option" id="option-existing">
                    <input type="radio" name="user_mode" value="existing" class="mode-switch-input" onchange="toggleCustomerSelect(this)">
                    ğŸ‘¥ è€ç”¨æˆ·
                </label>
            </div>
            
            <!-- åˆ›å»ºæ–°ç”¨æˆ·æ—¶çš„è‡ªå®šä¹‰ç”¨æˆ·åè¾“å…¥ -->
            <div id="new-username-input" class="form-group">
                <label for="custom_username" class="form-label">ç”¨æˆ·å</label>
                <input type="text" 
                       id="custom_username" 
                       name="custom_username" 
                       class="form-control" 
                       placeholder="è¯·è¾“å…¥ç”¨æˆ·å..."
                       style="padding: 12px;">
                <small style="color: #94a3b8; display: block; margin-top: 5px;">
                    å¦‚æœä¸å¡«å†™ï¼Œå°†ä½¿ç”¨Excelä¸­çš„å®¢æˆ·å
                </small>
            </div>
            
            <!-- é€‰æ‹©å·²æœ‰ç”¨æˆ· -->
            <div id="existing-customer-select" class="form-group" style="display: none;">
                <label for="existing_customer_id" class="form-label">é€‰æ‹©å®¢æˆ·</label>
                <div class="period-select-wrapper">
                    <select id="existing_customer_id" name="existing_customer_id" class="form-control" style="appearance: none; padding: 12px;">
                        <option value="">-- è¯·é€‰æ‹©å®¢æˆ· --</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- æµæ°´æœŸæ•°é€‰æ‹© -->
            <div class="form-group">
                <label for="period_number" class="form-label">æµæ°´æœŸæ•°</label>
                <div class="period-select-wrapper">
                    <select id="period_number" name="period_number" class="form-control" style="appearance: none; padding: 12px;">
                        {% for i in range(1, 13) %}
                        <option value="{{ i }}">ç¬¬ {{ i }} æœŸ</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="file-upload-area" id="drop-zone">
                <input type="file" 
                       id="file" 
                       name="file" 
                       class="file-input" 
                       accept=".xlsx,.xls"
                       required
                       onchange="updateFileName(this)">
                <span class="file-upload-icon">ğŸ“‚</span>
                <div class="file-upload-text">ç‚¹å‡»é€‰æ‹©Excelæ–‡ä»¶</div>
                <div class="file-upload-hint">æ”¯æŒ .xlsx, .xls æ ¼å¼</div>
            </div>
            
            <div id="file-name-display">
                <i>ğŸ“„</i> <span id="file-name-text"></span>
            </div>
            
            <div style="margin-top: 30px;">
                <button type="submit" class="action-btn btn-primary-custom">
                    ğŸ“¥ å¯¼å…¥ Excel
                </button>
                
                <a href="{{ url_for('admin.dashboard') }}" class="action-btn btn-secondary-custom" style="text-decoration: none; text-align: center;">
                    è¿”å›ä»ªè¡¨ç›˜
                </a>
            </div>
        </form>
        {% endif %}
    </div>
</div>

<script>
function toggleCustomerSelect(radio) {
    var mode = radio.value;
    var usernameDiv = document.getElementById('new-username-input');
    var selectDiv = document.getElementById('existing-customer-select');
    var optionNew = document.getElementById('option-new');
    var optionExisting = document.getElementById('option-existing');
    
    // åˆ‡æ¢æ ·å¼
    if (mode === 'new') {
        optionNew.classList.add('active');
        optionExisting.classList.remove('active');
        usernameDiv.style.display = 'block';
        selectDiv.style.display = 'none';
    } else {
        optionNew.classList.remove('active');
        optionExisting.classList.add('active');
        usernameDiv.style.display = 'none';
        selectDiv.style.display = 'block';
    }
}

function updateFileName(input) {
    var fileNameDisplay = document.getElementById('file-name-display');
    var fileNameText = document.getElementById('file-name-text');
    var dropZone = document.getElementById('drop-zone');
    
    if (input.files && input.files[0]) {
        fileNameText.textContent = input.files[0].name;
        fileNameDisplay.style.display = 'flex';
        dropZone.style.borderColor = 'var(--primary-color)';
        dropZone.style.background = '#eff6ff';
    } else {
        fileNameDisplay.style.display = 'none';
        dropZone.style.borderColor = '#cbd5e1';
        dropZone.style.background = '#f8fafc';
    }
}

// æ‹–æ‹½æ•ˆæœ
var dropZone = document.getElementById('drop-zone');
if (dropZone) {
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', function(e) {
        this.classList.remove('drag-over');
    });
}
</script>
{% endblock %}
