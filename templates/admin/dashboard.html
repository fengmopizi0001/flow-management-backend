{% extends "base.html" %}

{% block title %}ç®¡ç†å‘˜ä»ªè¡¨ç›˜ - æµæ°´ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>ğŸ“Š ç®¡ç†å‘˜ä»ªè¡¨ç›˜</h2>
    </div>
    <div class="card-body">
        <p>æ¬¢è¿å›æ¥ï¼Œ{{ session.username }}ï¼</p>
    </div>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid">
    <div class="stat-card info">
        <div class="stat-label">å®¢æˆ·æ•°é‡</div>
        <div class="stat-value">{{ stats.customer_count or 0 }}</div>
        <div>ä¸ª</div>
    </div>
    <div class="stat-card success">
        <div class="stat-label">å·²åˆ·æµæ°´</div>
        <div class="stat-value">Â¥{{ "{:,.0f}".format(stats.completed or 0) }}</div>
        <div>å…ƒ</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">æ€»æµæ°´</div>
        <div class="stat-value">Â¥{{ "{:,.0f}".format(stats.total or 0) }}</div>
        <div>å…ƒ</div>
    </div>
</div>

<!-- å®¢æˆ·è¯¦æƒ…é¢æ¿ -->
<div class="card" id="customer-detail-panel" style="display: none;">
    <div class="card-header">
        <h3>ğŸ“Š <span id="detail-customer-name">å®¢æˆ·åç§°</span> - æµæ°´è¯¦æƒ…</h3>
    </div>
    <div class="card-body">
        <div class="stats-grid">
            <div class="stat-card success">
                <div class="stat-label">å·²åˆ·æµæ°´</div>
                <div class="stat-value" id="detail-completed">Â¥0.00</div>
            </div>
            
            <div class="stat-card warning">
                <div class="stat-label">å½“æ—¥æµæ°´</div>
                <div class="stat-value" id="detail-daily">Â¥0.00</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-label">æ€»æµæ°´</div>
                <div class="stat-value" id="detail-total">Â¥0.00</div>
            </div>
        </div>
        
        <!-- å½“æ—¥å®Œæˆåº¦è¿›åº¦æ¡ -->
        <div style="margin-top: 20px;">
            <div class="stat-label">å½“æ—¥å®Œæˆåº¦</div>
            <div class="progress">
                <div class="progress-bar" id="detail-progress" style="width: 0%">0%</div>
            </div>
            <div class="text-center" style="margin-top: 10px;">
                <span id="detail-progress-text">å®Œæˆåº¦ï¼š0%</span>
            </div>
        </div>
    </div>
</div>

<!-- å¿«æ·æ“ä½œ -->
<div class="card">
    <div class="card-header">
        <h3>âš¡ å¿«æ·æ“ä½œ</h3>
    </div>
    <div class="card-body">
        <div class="quick-actions-grid">
            <a href="{{ url_for('admin.import_excel') }}" class="action-card">
                <div class="action-icon">ğŸ“¥</div>
                <div class="action-text">å¯¼å…¥Excel</div>
            </a>
            <a href="{{ url_for('admin.add_record') }}" class="action-card">
                <div class="action-icon">â•</div>
                <div class="action-text">å½•å…¥æµæ°´</div>
            </a>
            <a href="{{ url_for('admin.add_target') }}" class="action-card">
                <div class="action-icon">ğŸ¯</div>
                <div class="action-text">æ·»åŠ ç›®æ ‡</div>
            </a>
            <a href="{{ url_for('admin.view_records') }}" class="action-card">
                <div class="action-icon">ğŸ“‹</div>
                <div class="action-text">æŸ¥çœ‹è®°å½•</div>
            </a>
            <a href="{{ url_for('admin.reconciliation') }}" class="action-card">
                <div class="action-icon">ğŸ’¼</div>
                <div class="action-text">å¯¹è´¦æŠ¥è¡¨</div>
            </a>
        </div>
    </div>
</div>

<!-- ç›®æ ‡ç®¡ç†åˆ—è¡¨ -->
<div class="card mb-4" style="margin-bottom: 20px;">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">ğŸ“Š ç›®æ ‡ç®¡ç†åˆ—è¡¨ <small class="text-muted" style="font-size: 0.6em;">(å…± {{ targets|length }} æ¡)</small></h3>
        <a href="{{ url_for('admin.add_target') }}" class="btn btn-primary btn-sm">â• æ·»åŠ ç›®æ ‡</a>
    </div>
    <div class="card-body">
        {% if targets %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ç”¨æˆ·</th>
                        <th>æœŸæ•°</th>
                        <th>æ—¶é—´èŒƒå›´</th>
                        <th>ç›®æ ‡é‡‘é¢</th>
                        <th>å®Œæˆè¿›åº¦</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for target in targets %}
                    {% set completed = target.completed_amount or 0 %}
                    {% set percent = (completed / target.target_amount * 100)|round(1) if target.target_amount > 0 else 0 %}
                    <tr>
                        <td><strong>{{ target.username }}</strong></td>
                        <td><span class="badge badge-info" style="background-color: #17a2b8; color: white; padding: 0.25em 0.4em; border-radius: 0.25rem;">ç¬¬ {{ target.period_number }} æœŸ</span></td>
                        <td>{{ target.start_date }} <br><span class="text-muted" style="font-size: 0.85em;">è‡³</span><br> {{ target.end_date }}</td>
                        <td>Â¥{{ "{:,.2f}".format(target.target_amount) }}</td>
                        <td style="min-width: 150px;">
                            <div style="display: flex; align-items: center; margin-bottom: 5px;">
                                <div style="flex-grow: 1; background-color: #e9ecef; height: 10px; border-radius: 5px; margin-right: 10px; overflow: hidden;">
                                    <div style="width: {{ percent if percent <= 100 else 100 }}%; background-color: {{ '#28a745' if percent >= 100 else '#007bff' }}; height: 100%;"></div>
                                </div>
                                <span style="font-size: 0.85em;">{{ percent }}%</span>
                            </div>
                            <small class="text-muted" style="font-size: 0.85em;">å·²å®Œæˆ: Â¥{{ "{:,.2f}".format(completed) }}</small>
                        </td>
                        <td>
                            {% if percent >= 100 %}
                            <span class="badge badge-success" style="background-color: #28a745; color: white; padding: 0.25em 0.4em; border-radius: 0.25rem;">å·²è¾¾æ ‡</span>
                            {% else %}
                            <span class="badge badge-warning" style="background-color: #ffc107; color: black; padding: 0.25em 0.4em; border-radius: 0.25rem;">è¿›è¡Œä¸­</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('admin.edit_target', target_id=target.id) }}" class="btn btn-sm btn-primary" title="ç¼–è¾‘">âœï¸</a>
                            <form action="{{ url_for('admin.delete_target', target_id=target.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('âš ï¸ ç¡®å®šè¦åˆ é™¤è¯¥ç›®æ ‡å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼');">
                                <button type="submit" class="btn btn-sm btn-danger" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div style="text-center: center; padding: 20px; color: #6c757d; text-align: center;">
            <p>æš‚æ— ç›®æ ‡æ•°æ®</p>
            <a href="{{ url_for('admin.add_target') }}" class="btn btn-outline-primary btn-sm">ç«‹å³æ·»åŠ </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- å®¢æˆ·åˆ—è¡¨ -->
<div class="card">
    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">ğŸ‘¥ å®¢æˆ·åˆ—è¡¨</h3>
        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addUserModal">
            â• æ·»åŠ æ–°ç”¨æˆ·
        </button>
    </div>
    <div class="card-body">
        {% if customers %}
        <div class="table-responsive">
            <table class="table customer-list-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>è§’è‰²</th>
                    <th>æ³¨å†Œæ—¶é—´</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
                <tbody>
                    {% for customer in customers %}
                    <tr>
                        <td data-label="ID">{{ customer.id }}</td>
                        <td data-label="ç”¨æˆ·å">
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px;">
                                <a href="javascript:void(0)" 
                                   class="customer-link"
                                   data-customer-id="{{ customer.id }}"
                                   data-customer-name="{{ customer.username }}">
                                    {{ customer.username }}
                                </a>
                                <div style="display: flex; gap: 5px;">
                                    <button class="btn btn-primary btn-sm reset-password-btn" 
                                            data-user-id="{{ customer.id }}" 
                                            data-user-name="{{ customer.username }}"
                                            title="é‡ç½®å¯†ç ">
                                        ğŸ”„
                                    </button>
                                    <button class="btn btn-danger btn-sm delete-user-btn" 
                                            data-user-id="{{ customer.id }}" 
                                            data-user-name="{{ customer.username }}"
                                            title="åˆ é™¤">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </div>
                        </td>
                        <td data-label="è§’è‰²">å®¢æˆ·</td>
                        <td data-label="æ³¨å†Œæ—¶é—´">{{ customer.created_at[:10] }}</td>
                        <td data-label="æ“ä½œ">
                            <!-- ç§»åŠ¨ç«¯éšè—æ­¤åˆ—ï¼ŒæŒ‰é’®å·²åˆå¹¶åˆ°ç”¨æˆ·ååˆ— -->
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <div class="empty-state-text">æš‚æ— å®¢æˆ·</div>
            <p>è¯·å…ˆå¯¼å…¥Excelæ·»åŠ å®¢æˆ·</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- æ·»åŠ æ–°ç”¨æˆ·æ¨¡æ€æ¡† -->
<div class="modal" id="addUserModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>â• æ·»åŠ æ–°ç”¨æˆ·</h3>
            <button class="close" onclick="closeModal('addUserModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="newUsername">ç”¨æˆ·å <span style="color: red;">*</span></label>
                <input type="text" id="newUsername" class="form-control" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
            </div>
            <div class="form-group">
                <label for="newPassword">å¯†ç </label>
                <input type="password" id="newPassword" class="form-control" placeholder="ç•™ç©ºåˆ™é»˜è®¤å¯†ç ä¸º123456">
                <small class="text-muted">ç•™ç©ºåˆ™é»˜è®¤å¯†ç ä¸º123456</small>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">å–æ¶ˆ</button>
            <button type="button" class="btn btn-primary" onclick="addNewUser()">ç¡®å®šæ·»åŠ </button>
        </div>
    </div>
</div>

<script>
// æ‰“å¼€æ¨¡æ€æ¡†
document.querySelectorAll('[data-target="#addUserModal"]').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var modalId = this.getAttribute('data-target').replace('#', '');
        document.getElementById(modalId).style.display = 'block';
    });
});

// å…³é—­æ¨¡æ€æ¡†
function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    // æ¸…ç©ºè¡¨å•
    document.getElementById('newUsername').value = '';
    document.getElementById('newPassword').value = '';
}

// æ·»åŠ æ–°ç”¨æˆ·
function addNewUser() {
    var username = document.getElementById('newUsername').value.trim();
    var password = document.getElementById('newPassword').value.trim();
    
    // éªŒè¯ç”¨æˆ·å
    if (!username) {
        alert('è¯·è¾“å…¥ç”¨æˆ·åï¼');
        return;
    }
    
    if (username.length < 2) {
        alert('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦ï¼');
        return;
    }
    
    // æ„å»ºè¯·æ±‚æ•°æ®
    var data = {
        username: username
    };
    
    if (password && password.trim() !== '') {
        data.password = password;
    }
    
    // å‘é€è¯·æ±‚
    fetch('/admin/api/add_customer', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(function(response) { return response.json(); })
    .then(function(result) {
        if (result.success) {
            alert('ç”¨æˆ· "' + result.username + '" æ·»åŠ æˆåŠŸï¼\né»˜è®¤å¯†ç ï¼š' + (password || '123456'));
            closeModal('addUserModal');
            // é‡æ–°åŠ è½½é¡µé¢
            window.location.reload();
        } else {
            alert('æ·»åŠ å¤±è´¥ï¼š' + result.error);
        }
    })
    .catch(function(error) {
        console.error('æ·»åŠ å¤±è´¥:', error);
        alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
// å®¢æˆ·é“¾æ¥ç‚¹å‡»äº‹ä»¶
document.querySelectorAll('.customer-link').forEach(function(link) {
    link.addEventListener('click', function() {
        var customerId = this.getAttribute('data-customer-id');
        var customerName = this.getAttribute('data-customer-name');
        
        // åŠ è½½å®¢æˆ·è¯¦æƒ…
        loadCustomerDetail(customerId, customerName);
    });
});

// é‡ç½®å¯†ç æŒ‰é’®äº‹ä»¶
document.querySelectorAll('.reset-password-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var userId = this.getAttribute('data-user-id');
        var userName = this.getAttribute('data-user-name');
        
        var newPassword = prompt('è¯·è¾“å…¥æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™é‡ç½®ä¸º123456ï¼‰ï¼š', '');
        if (newPassword !== null) {
            resetPassword(userId, userName, newPassword);
        }
    });
});

// åˆ é™¤ç”¨æˆ·æŒ‰é’®äº‹ä»¶
document.querySelectorAll('.delete-user-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        var userId = this.getAttribute('data-user-id');
        var userName = this.getAttribute('data-user-name');
        
        if (confirm('ç¡®å®šè¦åˆ é™¤å®¢æˆ· "' + userName + '" å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥å®¢æˆ·çš„æ‰€æœ‰æµæ°´è®°å½•å’Œæœˆåº¦ç›®æ ‡ï¼Œä¸”æ— æ³•æ¢å¤ï¼')) {
            deleteUser(userId, this);
        }
    });
});

// é‡ç½®å¯†ç 
function resetPassword(userId, userName, newPassword) {
    var data = {};
    if (newPassword && newPassword.trim() !== '') {
        data.password = newPassword.trim();
    }
    
    fetch('/admin/reset_password/' + userId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(function(response) { return response.json(); })
    .then(function(result) {
        if (result.success) {
            alert(result.message);
        } else {
            alert('é‡ç½®å¤±è´¥ï¼š' + result.error);
        }
    })
    .catch(function(error) {
        console.error('é‡ç½®å¤±è´¥:', error);
        alert('é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}

// åŠ è½½å®¢æˆ·è¯¦æƒ…
function loadCustomerDetail(customerId, customerName) {
    fetch('/api/customer/' + customerId + '/stats')
        .then(function(response) { return response.json(); })
        .then(function(data) {
            // æ›´æ–°å®¢æˆ·åç§°
            document.getElementById('detail-customer-name').textContent = customerName;
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('detail-completed').textContent = 
                'Â¥' + data.completed_flow.toLocaleString('zh-CN', {minimumFractionDigits: 2});
            
            document.getElementById('detail-daily').textContent = 
                'Â¥' + data.daily_flow.toLocaleString('zh-CN', {minimumFractionDigits: 2});
            
            document.getElementById('detail-total').textContent = 
                'Â¥' + data.total_flow.toLocaleString('zh-CN', {minimumFractionDigits: 2});
            
            // æ›´æ–°å½“æ—¥å®Œæˆåº¦
            var rate = data.daily_completion_rate.toFixed(1);
            document.getElementById('detail-progress').style.width = rate + '%';
            document.getElementById('detail-progress').textContent = rate + '%';
            document.getElementById('detail-progress-text').textContent = 'å®Œæˆåº¦ï¼š' + rate + '%';
            
            // æ˜¾ç¤ºè¯¦æƒ…é¢æ¿
            document.getElementById('customer-detail-panel').style.display = 'block';
            
            // æ»šåŠ¨åˆ°è¯¦æƒ…é¢æ¿
            document.getElementById('customer-detail-panel').scrollIntoView({behavior: 'smooth'});
        })
        .catch(function(error) {
            console.error('åŠ è½½å¤±è´¥:', error);
            alert('åŠ è½½å®¢æˆ·è¯¦æƒ…å¤±è´¥');
        });
}

// åˆ é™¤ç”¨æˆ·
function deleteUser(userId, btnElement) {
    fetch('/admin/delete_user/' + userId, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
        if (data.success) {
            alert('åˆ é™¤æˆåŠŸï¼');
            // é‡æ–°åŠ è½½é¡µé¢
            window.location.reload();
        } else {
            alert('åˆ é™¤å¤±è´¥ï¼š' + data.error);
        }
    })
    .catch(function(error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    });
}
</script>
{% endblock %}
