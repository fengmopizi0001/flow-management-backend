{% extends "base.html" %}

{% block title %}æŸ¥è¯¢æµæ°´ - {{ customer.username }} - æµæ°´ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2>ğŸ” æŸ¥è¯¢æµæ°´ - {{ customer.username }}</h2>
        <a href="{{ url_for('admin.customer_query_select') }}" class="btn btn-secondary btn-sm">åˆ‡æ¢å®¢æˆ·</a>
    </div>
    <div class="card-body">
        <!-- ç­›é€‰è¡¨å• -->
        <form id="queryForm" class="content-section">
            <div class="form-group">
                <label class="form-label">æ—¥æœŸåŒºé—´</label>
                <div class="mobile-date-container">
                    <div class="date-row">
                        <label class="date-label">èµ·å§‹æ—¥æœŸï¼š</label>
                        <div class="date-picker-container">
                            <input type="hidden" id="startDate">
                            <select class="form-control year-select" name="start_year"></select>
                            <select class="form-control month-select" name="start_month"></select>
                            <select class="form-control day-select" name="start_day"></select>
                        </div>
                    </div>
                    <div class="date-row mt-3">
                        <label class="date-label">ç»“æŸæ—¥æœŸï¼š</label>
                        <div class="date-picker-container">
                            <input type="hidden" id="endDate">
                            <select class="form-control year-select" name="end_year"></select>
                            <select class="form-control month-select" name="end_month"></select>
                            <select class="form-control day-select" name="end_day"></select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                 <button type="button" class="btn btn-info btn-sm mt-2" onclick="setQueryToday()">ğŸ“… è®¾ç½®ä¸ºå½“å‰æ—¶é—´</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ“ä½œå‘˜</label>
                <select class="form-control" id="operatorSelect">
                    <option value="">å…¨éƒ¨</option>
                    <option value="self">è‡ªå·±</option>
                    {% for operator in operators %}
                    <option value="{{ operator.id }}">{{ operator.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">æ”¯ä»˜æ¸ é“</label>
                <select class="form-control" id="channelSelect">
                    <option value="">å…¨éƒ¨</option>
                    <option value="0">ä¸é€‰æ‹©</option>
                    <option value="1">å¾®ä¿¡æ”¯ä»˜</option>
                    <option value="2">æ”¯ä»˜å®</option>
                    <option value="3">å…¶ä»–æ¸ é“</option>
                </select>
            </div>
            
            <button type="submit" class="btn btn-primary btn-block-mobile">ğŸ” æŸ¥è¯¢</button>
        </form>
    </div>
</div>

<!-- æŸ¥è¯¢ç»“æœ -->
<div id="results" class="results-container">
    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="simple-stats">
        <div class="simple-stat-item">
            <div class="simple-stat-label">æ€»è®°å½•æ•°</div>
            <div class="simple-stat-value" id="totalCount">0</div>
        </div>
        <div class="simple-stat-item">
            <div class="simple-stat-label">æ€»é‡‘é¢</div>
            <div class="simple-stat-value" id="totalAmount">Â¥0</div>
        </div>
    </div>
    
    <!-- ç»“æœè¡¨æ ¼ -->
    <div class="card">
        <div class="card-header">
            <h3>æŸ¥è¯¢ç»“æœ</h3>
        </div>
        <div class="card-body">
            <!-- æ¡Œé¢ç«¯è¡¨æ ¼ -->
            <div class="desktop-table table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ</th>
                            <th>é‡‘é¢</th>
                            <th>æ“ä½œå‘˜</th>
                            <th>æ”¯ä»˜æ¸ é“</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTable">
                    </tbody>
                </table>
            </div>

            <!-- ç§»åŠ¨ç«¯å¡ç‰‡ -->
            <div id="mobileResults" class="mobile-results">
            </div>
            
            <div id="noResults" class="empty-state" style="display: none;">
                <div class="empty-state-icon">ğŸ”</div>
                <div class="empty-state-text">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</div>
            </div>
        </div>
    </div>
</div>

<!-- è¿”å›æŒ‰é’® -->
<div class="mt-4">
    <a href="{{ url_for('admin.customer_query_select') }}" class="btn btn-secondary btn-block">
        è¿”å›é€‰æ‹©å®¢æˆ·
    </a>
</div>

<script>
// è®¾ç½®å½“å‰æ—¶é—´åŠŸèƒ½
function setQueryToday() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    
    // æŸ¥æ‰¾æ‰€æœ‰ç›¸å…³çš„selectå¹¶è®¾ç½®å€¼
    document.querySelectorAll('.year-select').forEach(el => el.value = year);
    document.querySelectorAll('.month-select').forEach(el => el.value = month);
    
    // æ›´æ–°å¤©æ•°é€‰é¡¹ï¼ˆå› ä¸ºæœˆä»½å˜äº†ï¼‰
    if (window.datePicker && window.datePicker.updateDays) {
        window.datePicker.updateDays();
    }
    
    // ç„¶åè®¾ç½®å¤©
    setTimeout(() => {
        document.querySelectorAll('.day-select').forEach(el => el.value = day);
        // è§¦å‘changeäº‹ä»¶ä»¥æ›´æ–°éšè—input
        document.querySelectorAll('.day-select').forEach(el => el.dispatchEvent(new Event('change')));
    }, 0);
}

// é¡µé¢åŠ è½½å®Œæˆåï¼Œè®¾ç½®é»˜è®¤æ—¥æœŸï¼ˆæœ€è¿‘30å¤©ï¼‰
document.addEventListener('DOMContentLoaded', function() {
    // ç­‰å¾…script.jsåˆå§‹åŒ–å®Œæˆ
    setTimeout(() => {
        const today = new Date();
        const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        
        function setDateSelects(containerIdx, date) {
            const containers = document.querySelectorAll('.date-picker-container');
            if (containers.length > containerIdx) {
                const container = containers[containerIdx];
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                const yearSel = container.querySelector('.year-select');
                const monthSel = container.querySelector('.month-select');
                
                if (yearSel) yearSel.value = year;
                if (monthSel) monthSel.value = month;
                
                // æ›´æ–°å¤©æ•°
                if (window.datePicker && window.datePicker.updateDays) {
                    window.datePicker.updateDays();
                }
                
                setTimeout(() => {
                    const daySel = container.querySelector('.day-select');
                    if (daySel) {
                        daySel.value = day;
                        daySel.dispatchEvent(new Event('change'));
                    }
                }, 0);
            }
        }
        
        // è®¾ç½®èµ·å§‹æ—¥æœŸ (index 0)
        setDateSelects(0, thirtyDaysAgo);
        
        // è®¾ç½®ç»“æŸæ—¥æœŸ (index 1)
        setDateSelects(1, today);
    }, 100);
});

// æäº¤æŸ¥è¯¢
document.getElementById('queryForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('Form submitted');
    
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const operatorId = document.getElementById('operatorSelect').value;
    const channelId = document.getElementById('channelSelect').value;
    
    // æ„å»ºæŸ¥è¯¢URL
    const queryUrl = "{{ url_for('admin.customer_query_search', customer_id=customer.id) }}";
    console.log('Query URL:', queryUrl);
    
    // æ˜¾ç¤ºåŠ è½½ä¸­
    const btn = this.querySelector('button[type="submit"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ æŸ¥è¯¢ä¸­...';
    btn.disabled = true;
    
    try {
        console.log('Sending request...');
        const response = await fetch(queryUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                start_date: startDate,
                end_date: endDate,
                operator_id: operatorId,
                channel_id: channelId
            })
        });
        
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Result:', result);
        
        if (result.success) {
            displayResults(result.records, result.stats);
        } else {
            alert('æŸ¥è¯¢å¤±è´¥ï¼š' + (result.error || 'æœªçŸ¥é”™è¯¯'));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('æŸ¥è¯¢è¯·æ±‚å¤±è´¥ï¼š' + error.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
});

function displayResults(records, stats) {
    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    document.getElementById('totalCount').textContent = stats.total_count;
    document.getElementById('totalAmount').textContent = 'Â¥' + stats.total_amount.toLocaleString();
    
    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
    document.getElementById('results').style.display = 'block';
    
    // å¡«å……è¡¨æ ¼
    const tbody = document.getElementById('resultsTable');
    tbody.innerHTML = '';
    
    if (records.length === 0) {
        document.getElementById('noResults').style.display = 'block';
        return;
    }
    
    document.getElementById('noResults').style.display = 'none';
    
    // å¡«å……è¡¨æ ¼ï¼ˆæ¡Œé¢ç«¯ï¼‰
    records.forEach(record => {
        const row = document.createElement('tr');
        
        const statusClass = record.status === 'done' ? 'badge-success' : 'badge-warning';
        const statusText = record.status === 'done' ? 'å·²å®Œæˆ' : 'å¾…åˆ·';
        
        row.innerHTML = `
            <td>${record.date}</td>
            <td>Â¥${record.amount.toLocaleString()}</td>
            <td>${record.operator_name || '-'}</td>
            <td>${record.channel_name || '-'}</td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
        `;
        
        tbody.appendChild(row);
    });

    // å¡«å……å¡ç‰‡ï¼ˆç§»åŠ¨ç«¯ï¼‰
    const mobileContainer = document.getElementById('mobileResults');
    mobileContainer.innerHTML = '';
    
    if (records.length === 0) {
        return;
    }
    
    records.forEach(record => {
        const statusClass = record.status === 'done' ? 'badge-success' : 'badge-warning';
        const statusText = record.status === 'done' ? 'å·²å®Œæˆ' : 'å¾…åˆ·';
        const statusIcon = record.status === 'done' ? 'âœ…' : 'â³';
        
        const card = document.createElement('div');
        card.className = 'mobile-result-card';
        card.innerHTML = `
            <div class="result-card-row">
                <span class="result-card-label"><span class="card-icon">ğŸ“…</span> æ—¥æœŸ</span>
                <span class="result-card-value">${record.date}</span>
            </div>
            <div class="result-card-row">
                <span class="result-card-label"><span class="card-icon">ğŸ’°</span> é‡‘é¢</span>
                <span class="result-card-value">Â¥${record.amount.toLocaleString()}</span>
            </div>
            <div class="result-card-row">
                <span class="result-card-label"><span class="card-icon">ğŸ‘¤</span> æ“ä½œå‘˜</span>
                <span class="result-card-value">${record.operator_name || '-'}</span>
            </div>
            <div class="result-card-row">
                <span class="result-card-label"><span class="card-icon">ğŸ“±</span> æ¸ é“</span>
                <span class="result-card-value">${record.channel_name || '-'}</span>
            </div>
            <div class="result-card-row">
                <span class="result-card-label"><span class="card-icon">${statusIcon}</span> çŠ¶æ€</span>
                <span class="result-card-value"><span class="badge ${statusClass}">${statusText}</span></span>
            </div>
        `;
        mobileContainer.appendChild(card);
    });
}
</script>
{% endblock %}
