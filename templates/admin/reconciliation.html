{% extends "base.html" %}

{% block title %}å¯¹è´¦æŠ¥è¡¨ - æµæ°´ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block content %}
<style>
    /* æ¡Œé¢ç«¯å¸ƒå±€æ ·å¼ - å¤ç”¨ view_records çš„æ ·å¼ */
    @media (min-width: 769px) {
        .records-filter-form .filter-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .records-filter-form .filter-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }
        
        .records-filter-form .form-group {
            margin-bottom: 0;
        }
        
        .records-filter-form .date-picker-container {
            display: flex;
            gap: 5px;
        }
    }
</style>
<div class="card">
    <div class="card-header">
        <h2>ğŸ’¼ å¯¹è´¦æŠ¥è¡¨</h2>
    </div>
    <div class="card-body">
        <!-- ç­›é€‰è¡¨å• -->
        <form method="GET" style="margin-bottom: 20px;" class="records-filter-form">
            <div class="filter-grid">
                <!-- ç¬¬ä¸€è¡Œï¼šå®¢æˆ· -->
                <div class="filter-row row-1">
                    <div class="form-group customer-group" style="width: 100%;">
                        <label for="customer_id" class="form-label">å®¢æˆ·</label>
                        <select id="customer_id" name="customer_id" class="form-control form-select" onchange="this.form.submit()">
                            <option value="">å…¨éƒ¨å®¢æˆ·</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}" {% if selected_customer == customer.id %}selected{% endif %}>
                                {{ customer.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- ç¬¬äºŒè¡Œï¼šèµ·å§‹æ—¥æœŸ -->
                <div class="filter-row row-2">
                    <div class="form-group">
                        <label class="form-label">èµ·å§‹æ—¥æœŸ</label>
                        <div class="date-picker-container" id="start_date_container">
                            <select class="form-control year-select" name="start_year"></select>
                            <select class="form-control month-select" name="start_month"></select>
                            <select class="form-control day-select" name="start_day"></select>
                        </div>
                    </div>
                </div>
                
                <!-- ç¬¬ä¸‰è¡Œï¼šç»“æŸæ—¥æœŸ -->
                <div class="filter-row row-3">
                    <div class="form-group">
                        <label class="form-label">ç»“æŸæ—¥æœŸ</label>
                        <div class="date-picker-container" id="end_date_container">
                            <select class="form-control year-select" name="end_year"></select>
                            <select class="form-control month-select" name="end_month"></select>
                            <select class="form-control day-select" name="end_day"></select>
                        </div>
                    </div>
                </div>
                
                <!-- ç¬¬å››è¡Œï¼šæŒ‰é’® -->
                <div class="filter-row row-4">
                    <div class="filter-buttons">
                        <button type="submit" class="btn btn-primary">ğŸ” ç­›é€‰</button>
                        <button type="button" class="btn btn-warning" onclick="clearDates()">ğŸ“… æ‰€æœ‰æœŸæ•°</button>
                        <a href="{{ url_for('admin.reconciliation') }}" class="btn btn-secondary">ğŸ”„ é‡ç½®</a>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- æŒ‰å®¢æˆ·ç»Ÿè®¡ -->
        <h3 style="margin: 20px 0 15px 0;">ğŸ‘¥ æŒ‰å®¢æˆ·ç»Ÿè®¡</h3>
        {% if customer_stats %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>å®¢æˆ·</th>
                        <th>å·²å®Œæˆç¬”æ•°</th>
                        <th>å·²å®Œæˆé‡‘é¢</th>
                        <th>æ€»ç¬”æ•°</th>
                        <th>æ€»é‡‘é¢</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in customer_stats %}
                    <tr>
                        <td data-label="å®¢æˆ·">{{ stat.username }}</td>
                        <td data-label="å·²å®Œæˆç¬”æ•°">{{ stat.completed_count or 0 }} ç¬”</td>
                        <td data-label="å·²å®Œæˆé‡‘é¢">Â¥{{ "{:,.2f}".format(stat.completed or 0) }}</td>
                        <td data-label="æ€»ç¬”æ•°">{{ stat.total_count or 0 }} ç¬”</td>
                        <td data-label="æ€»é‡‘é¢">Â¥{{ "{:,.2f}".format(stat.total or 0) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <div class="empty-state-text">æš‚æ— å®¢æˆ·æ•°æ®</div>
            <p>è¯·å…ˆå¯¼å…¥Excelæˆ–æ·»åŠ å®¢æˆ·</p>
        </div>
        {% endif %}
        
        <div style="margin-top: 20px;">
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary btn-block-mobile">
                è¿”å›ä»ªè¡¨ç›˜
            </a>
        </div>
    </div>
</div>

<script>
    function setToday() {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        const day = today.getDate();
        
        // Format as YYYY-MM-DD
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        setDateSelects('start', dateStr);
        setDateSelects('end', dateStr);
    }

    function setDateSelects(prefix, dateStr) {
        // dateStr format: YYYY-MM-DD
        const parts = dateStr.split('-');
        if (parts.length === 3) {
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]); 
            const day = parseInt(parts[2]);   
            
            // Helper to set value safely
            const setVal = (name, val) => {
                const el = document.querySelector(`select[name="${prefix}_${name}"]`);
                if (el) {
                    // For month/day, we might need padding or not depending on how options are generated
                    if (name === 'month' || name === 'day') {
                        el.value = String(val).padStart(2, '0');
                    } else {
                        el.value = val;
                    }
                }
            };
            
            setVal('year', year);
            setVal('month', month);
            setVal('day', day);
        }
    }

    function clearDates() {
        // Clear all date selects
        const selects = document.querySelectorAll('.year-select, .month-select, .day-select');
        selects.forEach(select => {
            select.value = '';
        });
        
        // Also clear hidden inputs if any (though script.js handles syncing, we rely on form submission)
        // script.js syncing works on 'change' event. 
        // Manually trigger change or just submit? 
        // If we just submit, the values might be sent as empty string or default?
        // Wait, script.js might re-populate defaults if empty?
        // Let's check script.js behavior. It sets defaults on init.
        // If we set value to '', it might show empty.
        
        // However, the backend logic:
        // start_date, end_date = parse_date_range_from_request(request)
        // If params are empty, it returns None.
        
        // But the select elements might not have an empty option if generated by script.js?
        // script.js generates 1-12, 1-31. It doesn't seem to have an empty option by default unless we add it.
        // Actually, if we look at view_records, resetting usually involves redirecting.
        
        // If we want to submit "empty" dates, we need the selects to have empty values.
        // Let's add empty option if not present? Or just redirect to URL with customer_id but without dates.
        
        const customerId = document.getElementById('customer_id').value;
        let url = "{{ url_for('admin.reconciliation') }}";
        if (customerId) {
            url += "?customer_id=" + customerId;
        }
        window.location.href = url;
    }
</script>
{% endblock %}
