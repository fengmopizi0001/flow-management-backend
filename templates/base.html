<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#007bff">
    <title>{% block title %}æµæ°´ç®¡ç†ç³»ç»Ÿ{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css', v='2.1') }}">
</head>
<body>
    {% if session.get('user_id') %}
    <nav class="navbar">
        <div class="container nav-content">
            {% if session.get('role') == 'admin' %}
            <a href="{{ url_for('admin.dashboard') }}" class="nav-brand">ğŸ’° æµæ°´ç®¡ç†ç³»ç»Ÿ</a>
            {% else %}
            <a href="{{ url_for('customer.dashboard') }}" class="nav-brand">ğŸ’° æµæ°´ç®¡ç†ç³»ç»Ÿ</a>
            {% endif %}
            <div class="nav-links">
                {% if session.get('role') == 'admin' %}
                <a href="{{ url_for('admin.dashboard') }}" class="nav-link {% if request.endpoint == 'admin.dashboard' %}active{% endif %}">ä»ªè¡¨ç›˜</a>
                <a href="{{ url_for('admin.import_excel') }}" class="nav-link {% if request.endpoint == 'admin.import_excel' %}active{% endif %}">å¯¼å…¥Excel</a>
                <a href="{{ url_for('admin.add_target') }}" class="nav-link {% if request.endpoint == 'admin.add_target' %}active{% endif %}">æ·»åŠ ç›®æ ‡</a>
                <a href="{{ url_for('admin.add_record') }}" class="nav-link {% if request.endpoint == 'admin.add_record' %}active{% endif %}">å½•å…¥æµæ°´</a>
                <a href="{{ url_for('admin.view_records') }}" class="nav-link {% if request.endpoint == 'admin.view_records' %}active{% endif %}">æŸ¥çœ‹è®°å½•</a>
                <a href="{{ url_for('admin.customer_query_select') }}" class="nav-link {% if request.endpoint == 'admin.customer_query_select' or request.endpoint == 'admin.customer_query_view' %}active{% endif %}">å®¢æˆ·æµæ°´æŸ¥è¯¢</a>
                <a href="{{ url_for('admin.reconciliation') }}" class="nav-link {% if request.endpoint == 'admin.reconciliation' %}active{% endif %}">å¯¹è´¦æŠ¥è¡¨</a>
                {% else %}
                <a href="{{ url_for('customer.dashboard') }}" class="nav-link {% if request.endpoint == 'customer.dashboard' %}active{% endif %}">ä»ªè¡¨ç›˜</a>
                <a href="{{ url_for('customer.records') }}" class="nav-link {% if request.endpoint == 'customer.records' %}active{% endif %}">æµæ°´æ˜ç»†</a>
                {% endif %}
                {% if session.get('role') == 'admin' %}
                <a href="javascript:void(0)" onclick="openChangeUsernameModal()" class="nav-link">ä¿®æ”¹ç”¨æˆ·å</a>
                {% endif %}
                <a href="javascript:void(0)" onclick="openChangePasswordModal()" class="nav-link">ä¿®æ”¹å¯†ç </a>
                <a href="{{ url_for('auth.logout') }}" class="nav-link">é€€å‡º</a>
            </div>
        </div>
    </nav>
    {% endif %}

    <main class="container" style="padding-top: 20px; padding-bottom: 20px;">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </main>

    <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª -->
    {% if session.get('user_id') and session.get('role') == 'customer' %}
    <nav class="bottom-nav">
        <a href="{{ url_for('customer.dashboard') }}" class="bottom-nav-item {% if request.endpoint == 'customer.dashboard' %}active{% endif %}">
            <span class="bottom-nav-icon">ğŸ“Š</span>
            <span class="bottom-nav-text">ä»ªè¡¨ç›˜</span>
        </a>
        <a href="{{ url_for('customer.records') }}" class="bottom-nav-item {% if request.endpoint == 'customer.records' %}active{% endif %}">
            <span class="bottom-nav-icon">ğŸ“‹</span>
            <span class="bottom-nav-text">æ˜ç»†</span>
        </a>
        <a href="{{ url_for('auth.logout') }}" class="bottom-nav-item">
            <span class="bottom-nav-icon">ğŸšª</span>
            <span class="bottom-nav-text">é€€å‡º</span>
        </a>
    </nav>
    {% endif %}

    <!-- æ–°ç‰ˆæ“ä½œå‘˜å’Œæ¸ é“é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="operatorChannelModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">é€‰æ‹©æ“ä½œå‘˜å’Œæ”¯ä»˜æ¸ é“</h2>
                <button type="button" class="modal-close" onclick="operatorChannelSelector.closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- æ“ä½œå‘˜åˆ—è¡¨ -->
                <div id="operatorListContainer">
                    <p style="margin-bottom: 15px; color: #6c757d;">è¯·é€‰æ‹©æ“ä½œå‘˜ï¼š</p>
                    <div id="operatorOptions" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px;">
                        <!-- æ“ä½œå‘˜é€‰é¡¹ä¼šåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                
                <!-- æ”¯ä»˜æ¸ é“åˆ—è¡¨ -->
                <div id="channelContainer" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                    <p style="margin-bottom: 15px; color: #6c757d;">è¯·é€‰æ‹©æ”¯ä»˜æ¸ é“ï¼š</p>
                    <div id="channelOptions" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- æ”¯ä»˜æ¸ é“é€‰é¡¹ä¼šåŠ¨æ€åŠ è½½ -->
                    </div>
                </div>
                
                <!-- æ–°å»ºæ“ä½œå‘˜è¡¨å• -->
                <div id="newOperatorFormContainer" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                    <p style="margin-bottom: 15px; color: #6c757d;">æ·»åŠ æ–°æ“ä½œå‘˜ï¼š</p>
                    <div class="form-group">
                        <label class="form-label">æ“ä½œå‘˜å§“å *</label>
                        <input type="text" id="newOperatorName" class="form-control" placeholder="è¾“å…¥æ“ä½œå‘˜å§“å">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ”¯ä»˜æ¸ é“ï¼ˆå¯å¤šé€‰ï¼‰</label>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="newChannels" value="å¾®ä¿¡æ”¯ä»˜"> å¾®ä¿¡æ”¯ä»˜
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="newChannels" value="æ”¯ä»˜å®"> æ”¯ä»˜å®
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="newChannels" value="å…¶ä»–"> å…¶ä»–
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button type="button" id="saveOperatorBtn" class="btn btn-primary" style="flex: 1;">ä¿å­˜</button>
                        <button type="button" id="cancelOperatorBtn" class="btn btn-secondary" style="flex: 1;">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œäººé€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="operatorModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">é€‰æ‹©æ“ä½œå‘˜å’Œæ¸ é“</h2>
                <button type="button" class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- æ“ä½œäººé€‰æ‹©åŒºåŸŸ - å¯ç¼–è¾‘ä¸‹æ‹‰æ¡† -->
                <div class="form-group">
                    <label for="operatorInput" class="form-label">é€‰æ‹©æ“ä½œäººï¼ˆå¯ç›´æ¥è¾“å…¥æ–°æ“ä½œå‘˜ï¼‰</label>
                    <input type="text" 
                           id="operatorInput" 
                           class="form-control" 
                           list="operatorList"
                           placeholder="é€‰æ‹©æˆ–è¾“å…¥æ“ä½œå‘˜å§“å">
                    <datalist id="operatorList">
                        <!-- å†å²æ“ä½œäººä¼šè‡ªåŠ¨åŠ è½½ -->
                    </datalist>
                    <input type="hidden" id="operatorId" value="">
                    
                    <!-- ç§»åŠ¨ç«¯ï¼šå†å²æ“ä½œå‘˜å¿«é€Ÿé€‰æ‹© -->
                    <div class="operator-quick-select">
                        <div class="quick-select-label">æˆ–ä»å†å²ä¸­é€‰æ‹©ï¼š</div>
                        <div class="operator-tags" id="operatorTags">
                            <!-- æ“ä½œå‘˜æ ‡ç­¾ä¼šåŠ¨æ€åŠ è½½ -->
                        </div>
                    </div>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #dee2e6;">
                
                <!-- æ¸ é“é€‰æ‹©åŒºåŸŸ -->
                <div class="form-group">
                    <label class="form-label">é€‰æ‹©æ”¯ä»˜æ¸ é“</label>
                    <div class="channel-options-container">
                        <label class="channel-option">
                            <input type="radio" name="channel" value="1" data-channel-name="å¾®ä¿¡æ”¯ä»˜">
                            <span class="channel-icon">ğŸ’¬</span>
                            <span class="channel-name">å¾®ä¿¡æ”¯ä»˜</span>
                        </label>
                        <label class="channel-option">
                            <input type="radio" name="channel" value="2" data-channel-name="æ”¯ä»˜å®">
                            <span class="channel-icon">ğŸ’³</span>
                            <span class="channel-name">æ”¯ä»˜å®</span>
                        </label>
                        <label class="channel-option">
                            <input type="radio" name="channel" value="3" data-channel-name="å…¶ä»–æ¸ é“">
                            <span class="channel-icon">ğŸ”€</span>
                            <span class="channel-name">å…¶ä»–æ¸ é“</span>
                        </label>
                    </div>
                </div>
                
                <!-- æŒ‰é’®ç»„ -->
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" id="closeOperatorModalBtn" class="btn btn-secondary" style="flex: 1;">
                        å–æ¶ˆ
                    </button>
                    <button type="button" id="confirmOperatorBtn" class="btn btn-primary" style="flex: 1;">
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹ç”¨æˆ·åæ¨¡æ€æ¡† -->
    <div id="changeUsernameModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ä¿®æ”¹ç”¨æˆ·å</h2>
                <button type="button" class="modal-close" onclick="closeChangeUsernameModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="changeUsernameForm">
                    <div class="form-group">
                        <label for="editCurrentUsername" class="form-label">å½“å‰ç”¨æˆ·å</label>
                        <input type="text" 
                               id="editCurrentUsername" 
                               class="form-control" 
                               value="{{ session.username }}"
                               readonly
                               disabled>
                    </div>
                    <div class="form-group">
                        <label for="editNewUsername" class="form-label">æ–°ç”¨æˆ·å <span style="color: red;">*</span></label>
                        <input type="text" 
                               id="editNewUsername" 
                               class="form-control" 
                               placeholder="è¯·è¾“å…¥æ–°ç”¨æˆ·å"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="editConfirmUsername" class="form-label">ç¡®è®¤æ–°ç”¨æˆ·å <span style="color: red;">*</span></label>
                        <input type="text" 
                               id="editConfirmUsername" 
                               class="form-control" 
                               placeholder="è¯·å†æ¬¡è¾“å…¥æ–°ç”¨æˆ·å"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="editUsernamePassword" class="form-label">å¯†ç  <span style="color: red;">*</span></label>
                        <input type="password" 
                               id="editUsernamePassword" 
                               class="form-control" 
                               placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
                               required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block-mobile">ç¡®è®¤ä¿®æ”¹</button>
                    <button type="button" class="btn btn-secondary btn-block-mobile" onclick="closeChangeUsernameModal()">å–æ¶ˆ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div id="changePasswordModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ä¿®æ”¹å¯†ç </h2>
                <button type="button" class="modal-close" onclick="closeChangePasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="oldPassword" class="form-label">æ—§å¯†ç </label>
                        <input type="password" 
                               id="oldPassword" 
                               class="form-control" 
                               placeholder="è¯·è¾“å…¥æ—§å¯†ç "
                               required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword" class="form-label">æ–°å¯†ç </label>
                        <input type="password" 
                               id="newPassword" 
                               class="form-control" 
                               placeholder="è¯·è¾“å…¥æ–°å¯†ç "
                               required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                        <input type="password" 
                               id="confirmPassword" 
                               class="form-control" 
                               placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
                               required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block-mobile">ç¡®è®¤ä¿®æ”¹</button>
                    <button type="button" class="btn btn-secondary btn-block-mobile" onclick="closeChangePasswordModal()">å–æ¶ˆ</button>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
    // æ‰“å¼€ä¿®æ”¹ç”¨æˆ·åæ¨¡æ€æ¡†
    function openChangeUsernameModal() {
        document.getElementById('changeUsernameModal').style.display = 'flex';
        document.getElementById('editNewUsername').focus();
    }
    
    // å…³é—­ä¿®æ”¹ç”¨æˆ·åæ¨¡æ€æ¡†
    function closeChangeUsernameModal() {
        document.getElementById('changeUsernameModal').style.display = 'none';
        document.getElementById('changeUsernameForm').reset();
    }
    
    // æäº¤ä¿®æ”¹ç”¨æˆ·åè¡¨å•
    const changeUsernameForm = document.getElementById('changeUsernameForm');
    if (changeUsernameForm) {
        changeUsernameForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newUsernameInput = document.getElementById('editNewUsername');
            const confirmUsernameInput = document.getElementById('editConfirmUsername');
            const passwordInput = document.getElementById('editUsernamePassword');
            
            const newUsername = newUsernameInput.value.trim();
            const confirmUsername = confirmUsernameInput.value.trim();
            const password = passwordInput.value;
            
            console.log('æ–°ç”¨æˆ·å:', newUsername);
            console.log('ç¡®è®¤ç”¨æˆ·å:', confirmUsername);
            console.log('å¯†ç :', password ? '***' : 'ç©º');
            
            // éªŒè¯æ–°ç”¨æˆ·å
            if (!newUsername) {
                alert('è¯·è¾“å…¥æ–°ç”¨æˆ·å');
                newUsernameInput.focus();
                return;
            }
            
            if (!confirmUsername) {
                alert('è¯·è¾“å…¥ç¡®è®¤æ–°ç”¨æˆ·å');
                confirmUsernameInput.focus();
                return;
            }
            
            if (newUsername !== confirmUsername) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„ç”¨æˆ·åä¸ä¸€è‡´\n\næ–°ç”¨æˆ·åï¼š' + newUsername + '\nç¡®è®¤ç”¨æˆ·åï¼š' + confirmUsername);
                newUsernameInput.focus();
                return;
            }
            
            if (newUsername.length < 2) {
                alert('ç”¨æˆ·åé•¿åº¦ä¸èƒ½å°‘äº2ä¸ªå­—ç¬¦');
                newUsernameInput.focus();
                return;
            }
            
            const currentUsername = '{{ session.username }}';
            if (newUsername === currentUsername) {
                alert('æ–°ç”¨æˆ·åä¸èƒ½ä¸å½“å‰ç”¨æˆ·åç›¸åŒ\nå½“å‰ç”¨æˆ·åï¼š' + currentUsername);
                newUsernameInput.focus();
                return;
            }
            
            if (!password) {
                alert('è¯·è¾“å…¥å¯†ç ');
                passwordInput.focus();
                return;
            }
            
            try {
                const response = await fetch('/change_username', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        new_username: newUsername,
                        confirm_username: confirmUsername,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ç”¨æˆ·åä¿®æ”¹æˆåŠŸï¼è¯·é‡æ–°ç™»å½•');
                    window.location.href = "{{ url_for('auth.logout') }}";
                } else {
                    alert(result.message || 'ä¿®æ”¹å¤±è´¥');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        });
    }
    
    // æ‰“å¼€ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
    function openChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'flex';
        document.getElementById('oldPassword').focus();
    }
    
    // å…³é—­ä¿®æ”¹å¯†ç æ¨¡æ€æ¡†
    function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'none';
        document.getElementById('changePasswordForm').reset();
    }
    
    // æäº¤ä¿®æ”¹å¯†ç è¡¨å•
    const changePasswordForm = document.getElementById('changePasswordForm');
    if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // éªŒè¯æ–°å¯†ç 
            if (newPassword !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½');
                return;
            }
            
            try {
                const response = await fetch('/change_password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
                    window.location.href = "{{ url_for('auth.logout') }}";
                } else {
                    alert(result.error || 'ä¿®æ”¹å¤±è´¥');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            }
        });
    }
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
