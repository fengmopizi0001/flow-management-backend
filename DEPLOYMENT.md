# 流水管理系统 - 新电脑部署指南

## 📋 目录
- [快速部署](#快速部署)
- [详细步骤](#详细步骤)
- [花生壳配置](#花生壳配置)
- [常见问题](#常见问题)
- [维护说明](#维护说明)

---

## 🚀 快速部署

### 三步完成部署

1. **复制项目文件**
   - 将整个项目文件夹复制到新电脑
   - 建议放在 `C:\flow-management` 或其他固定位置

2. **安装环境**
   - 双击运行 `install.bat`
   - 等待安装完成（首次运行需要下载依赖，可能需要几分钟）

3. **启动服务**
   - 双击运行 `start_background.bat`
   - 服务将在后台运行，访问 `http://localhost:5000` 测试

---

## 📖 详细步骤

### 第一步：准备Python环境

#### 安装Python
1. 访问 [Python官网](https://www.python.org/downloads/)
2. 下载Python 3.8或更高版本
3. 安装时**务必勾选** "Add Python to PATH"
4. 安装完成后，打开命令行输入以下命令验证：
   ```cmd
   python --version
   pip --version
   ```

#### 运行安装脚本
```cmd
install.bat
```

该脚本会自动完成：
- ✅ 检查Python环境
- ✅ 升级pip
- ✅ 创建必要的目录（data、logs、uploads）
- ✅ 安装所有依赖包

### 第二步：启动应用

#### 后台模式（推荐）
```cmd
start_background.bat
```

**特点：**
- 服务在后台运行，关闭窗口不影响服务
- 自动设置为生产环境模式
- 日志输出到 `logs/app.log`

#### 前台模式（调试用）
```cmd
启动新版本.bat
```

**特点：**
- 显示实时日志
- 按 Ctrl+C 停止服务
- 适合开发和调试

### 第三步：验证服务

#### 检查服务状态
```cmd
status.bat
```

该脚本会显示：
- 服务运行状态
- 端口监听情况
- 本地和局域网访问地址
- 最近日志内容

#### 浏览器访问
打开浏览器访问：
- 本地：`http://localhost:5000`
- 局域网：`http://YOUR_IP:5000`

默认账户：
- 管理员：`admin` / `admin123`

---

## 🌐 花生壳配置

### 配置内网穿透

#### 1. 注册登录
- 访问 [花生壳官网](https://hsk.oray.com/)
- 注册并登录账号

#### 2. 安装客户端
- 下载Windows版花生壳客户端
- 安装并登录

#### 3. 创建映射
1. 打开花生壳客户端
2. 点击"添加映射"
3. 填写以下信息：
   ```
   应用名称：流水管理系统
   应用协议：HTTP
   映射类型：免费版/个人版
   内网主机：127.0.0.1（或本机IP）
   内网端口：5000
   外网端口：自动分配
   域名：使用免费域名
   ```
4. 点击"保存"

#### 4. 获取外网地址
映射创建成功后，会显示类似：
```
外网访问地址：http://xxx.hsk.oray.com:PORT
```

#### 5. 测试外网访问
使用外网地址在浏览器访问，确认可以正常打开系统

---

## 🔧 服务管理

### 常用命令

#### 启动服务
```cmd
start_background.bat
```

#### 停止服务
```cmd
stop.bat
```

#### 查看状态
```cmd
status.bat
```

#### 查看日志
直接打开 `logs\app.log` 文件

### 设置开机自启动

#### 方法1：使用启动文件夹
1. 按 `Win + R`，输入 `shell:startup`
2. 创建 `start_background.bat` 的快捷方式
3. 将快捷方式复制到打开的文件夹中

#### 方法2：使用任务计划程序（推荐）
1. 打开"任务计划程序"
2. 创建基本任务
3. 设置触发器：计算机启动时
4. 设置操作：启动程序
5. 程序路径：选择 `start_background.bat`
6. 完成

---

## ⚠️ 常见问题

### 问题1：install.bat报错"未检测到Python环境"

**原因：** Python未安装或未添加到PATH

**解决方法：**
1. 确认Python已安装
2. 重新安装Python，确保勾选"Add Python to PATH"
3. 或手动添加Python到系统PATH

### 问题2：服务启动失败

**检查步骤：**
1. 运行 `status.bat` 查看错误信息
2. 打开 `logs\app.log` 查看详细日志
3. 确认5000端口未被占用：
   ```cmd
   netstat -ano | findstr :5000
   ```

**常见原因：**
- 端口被占用 → 修改config.py中的PORT
- 依赖缺失 → 重新运行 `install.bat`
- 数据库文件损坏 → 删除data/flow.db，重启自动重建

### 问题3：无法访问外网地址

**检查步骤：**
1. 确认本地服务正常运行：访问 `http://localhost:5000`
2. 检查花生壳客户端状态：确认映射在线
3. 检查防火墙设置
4. 尝试重启花生壳客户端

### 问题4：上传文件失败

**原因：** uploads目录权限不足或大小超限

**解决方法：**
1. 确认uploads目录存在且有写权限
2. 检查文件大小（默认限制32MB）
3. 查看日志了解详细错误

---

## 🛠️ 维护说明

### 数据备份

#### 备份数据库
定期备份 `data/flow.db` 文件：
```cmd
xcopy data\flow.db data\backup_%date:~0,10%.db /Y
```

#### 备份配置文件
- `config.py` - 配置文件
- `production_config.py` - 生产环境配置

### 日志管理

#### 查看日志
- 运行 `status.bat` 查看最近日志
- 直接打开 `logs\app.log` 查看完整日志

#### 清理日志
建议定期清理旧日志，避免占用过多空间：
```cmd
del logs\app_*.log
```

### 更新部署

#### 更新代码
1. 停止服务：`stop.bat`
2. 复制新的项目文件覆盖旧文件
3. 备份数据库：`copy data\flow.db data\flow_backup.db`
4. 重新安装依赖：`install.bat`
5. 启动服务：`start_background.bat`

#### 更新依赖
```cmd
pip install --upgrade -r requirements.txt
```

---

## 🔒 安全建议

### 1. 修改默认密码
登录系统后，立即修改admin账户密码

### 2. 配置HTTPS（可选）
如果需要更安全的访问，可以：
- 购买SSL证书
- 使用Nginx反向代理
- 配置花生壳HTTPS映射

### 3. 限制访问（可选）
在config.py中配置：
```python
ALLOWED_IPS = ['192.168.1.100', '10.0.0.1']  # 允许的IP列表
```

### 4. 定期更新
- 定期更新Python依赖包
- 关注安全更新
- 备份重要数据

---

## 📞 技术支持

### 获取帮助
如遇到问题，请提供以下信息：
1. 错误截图或日志内容（logs/app.log）
2. 操作系统版本
3. Python版本
4. 详细的复现步骤

### 联系方式
- 查看README.md获取更多信息

---

## 📊 性能优化

### 1. 启用缓存
在production_config.py中已配置：
```python
ENABLE_CACHING = True
CACHE_TIMEOUT = 300  # 5分钟
```

### 2. 数据库优化
- 定期执行数据库维护
- 删除历史数据
- 使用索引优化查询

### 3. 网络优化
- 使用稳定的网络连接
- 考虑升级花生壳套餐获得更快的速度

---

## ✅ 部署检查清单

在完成部署后，请确认以下项：

- [ ] Python环境安装完成
- [ ] 所有依赖包安装成功
- [ ] 服务可以正常启动
- [ ] 本地访问正常（localhost:5000）
- [ ] 花生壳映射配置完成
- [ ] 外网访问正常
- [ ] 默认密码已修改
- [ ] 数据库备份策略已制定
- [ ] 日志查看正常
- [ ] 开机自启动已配置（可选）

---

## 📝 版本信息

- 系统版本：1.0
- 部署日期：2026-01-29
- 文档版本：1.0

---

**部署完成后，请妥善保管此文档，以备后续维护使用。**
